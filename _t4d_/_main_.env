t4dLoadFile "${WS_ROOT}/_t4d_/jenkins-utils.env"
t4dLoadFile "${WS_ROOT}/_t4d_/monitor-utils.env"
t4dLoadFile  "$WS_ROOT/_t4d_/generate-lib-utils.env"



_wksSync(){
# Generated From $Tools4Dev_PATH/utils/templates.env
# v1.5.0
###### _wksSync
#   - Name :
#       _wksSync
###
#   - Synopsis :
#       Oneline Description - Will be visible from wks help
###
#   - Note :
#       <Required>
#       [Optionnal]
#       {XXXXXXX}       = Value To Be Changed, if {URL} then replace {URL} with a valid URL
###### DOCUMENTATION BLOC #####
########### CODE BLOC #########
    local _t4dErrorCode=Unknown
    # mv "$(_t4dFindDataInXmlV2 folder name Home root inventory/jenkins-ci08)/_Base_" "$WS_ROOT/archive"
    # rm -rf "$(_t4dFindDataInXmlV2 folder name Home root inventory/jenkins-ci08)"
    mkdir -p "$(_t4dFindDataInXmlV2 folder name Home root $WS_CI_CONFIG_FILE)"
    # mv "$WS_ROOT/archive/_Base_" "$(_t4dFindDataInXmlV2 folder name Home root inventory/jenkins-ci08)"
    _wksJenkinsSyncFolder
    _wksJenkinsSyncPipeline
    _wksJenkinsSyncNode
    _wksJenkinsRestartServer
    _t4dPromptEchoTimer 45 "Waiting for Jenkins :"
    _wksJenkinsScanPipeline

###############################
}

_wksMonitor(){
# Generated From $Tools4Dev_PATH/Engine/G4d/templates.env
# v1.7.0
###### _wksMonitor
#   - Name:
#       _wksMonitor
###
#   - Synopsis:
#       Oneline Description - Will be visible from wks help
###
#   - Note:
#       <Required>
#       [Optionnal]
#       {XXXXXXX}       = Value To Be Changed, if {URL} then replace {URL} with a valid URL
###
###### DOCUMENTATION BLOC #####
########### CODE BLOC #########
    local _t4dErrorCode=1
    local _COLOR="$plwhite"
    local _Cent="$(_t4dPromptVarWithSpace $(expr $(expr $(_t4dPromptSize) - 90 ) / 2 ) "")"
    local _Sep="${_COLOR}|${pstd}"
    local _Nodes="$(_t4dFindMarkerInXML node name $WS_CI_CONFIG_FILE)"
    if [[ "$1" != "" ]]; then
        _Nodes="$(echo $_Nodes | grep "$1")"
    fi
    
    alias Header.Name="_t4dPromptVarCenterWithChar          --color \"$plpurple\" 20  'Name'        ' '"
    alias Data.Name.OSX="_t4dPromptVarCenterWithChar        --color \"$plcyan\" 20"
    alias Data.Name.Linux="_t4dPromptVarCenterWithChar      --color \"$plblue\"   20"
    alias Header.T4dVersion="_t4dPromptVarCenterWithChar    --color \"$plpurple\" 10  'T4D'         ' '"
    alias Header.DiskUsage="_t4dPromptVarCenterWithChar     --color \"$plpurple\" 23  'Disk Freespace'  ' '"
    alias Header.OsVersion="_t4dPromptVarCenterWithChar     --color \"$plpurple\" 12   'OS'         ' '"
    alias Header.ClangVersion="_t4dPromptVarCenterWithChar  --color \"$plpurple\" 10  'Clang'       ' '"
    alias Header.XcodeVersion="_t4dPromptVarCenterWithChar  --color \"$plpurple\" 10  'Xcode'       ' '"
    # alias Data.Line=""
    Data.Line(){
        local _Color="$1"
        local _Name="$2"
        local _Size="${3:-10}"
        echo "$(_t4dPromptVarCenterWithChar  --color $_Color $_Size  "${_Name}"       ' ')"
    }

    echo "${_Cent}$(_t4dPromptVarCenterWithChar --color "$_COLOR" 92 '' '+')" | sed 's|%||g'
    echo "${_Cent}${_Sep}$(Header.Name)${_Sep}$(Header.T4dVersion)${_Sep}$(Header.DiskUsage)${_Sep}$(Header.OsVersion)${_Sep}$(Header.ClangVersion)${_Sep}$(Header.XcodeVersion)${_Sep}" | sed 's|%||g'
    echo "${_Cent}${_Sep}$(Data.Line " " " " 19)${_Sep}$(Data.Line " " " " 9)${_Sep}$(_t4dPromptVarCenterWithChar --color $pigrey 23 "<Free> (<Used>+)" ' ')${_Sep}$(Data.Line " " " " 11)${_Sep}$(Data.Line " " " " 9)${_Sep}$(Data.Line " " " " 9)${_Sep}" | sed 's|%||g' | sed 's|+|%|g'
    echo "${_Cent}$(_t4dPromptVarCenterWithChar --color "$_COLOR" 92 '' '+')" | sed 's|%||g'
    for _Node in $(echo $_Nodes); do
        local _Ip="$(_t4dFindDataInXmlV2 node name $_Node ip $WS_CI_CONFIG_FILE)"
        local _type="$(_t4dFindDataInXmlV2 node name $_Node host $WS_CI_CONFIG_FILE)"
        local _Username="$(_t4dFindDataInXmlV2 credentials name default username $WS_CI_CONFIG_FILE)"
        
        if [[ "$(ping -c 1 -t 1 -W 1 $_Ip 2> /dev/null | grep -Eo ' 0.0% packet loss')" == ' 0.0% packet loss' ]]; then
            if [[ "$_type" == "linux" ]]; then
                local _Data="$(_t4dSrcFileSystemSshT4dOutput $_Username@$_Ip '/home/shared/Tools4Dev' '_t4dSystemHealthInfo')"
                local _version="$(      echo $_Data | grep 'T4D_VERSION' | cut -d '=' -f2)"
                local _OSversion="$(    echo $_Data | grep 'SYSTEM_VERSION' | cut -d '=' -f2)"
                local _ClangVersion="$( echo $_Data | grep 'CLANG_VERSION' | cut -d '=' -f2)"
                local _DiskUsage="$(    echo $_Data | grep 'DISK_AVAILABLE_SPACE' | cut -d '=' -f2)"
                local _DiskCapacity="$( echo $_Data | grep 'DISK_PERCENTAGE' | cut -d '=' -f2)"
                local _DiskTotal="$(    echo $_Data | grep 'DISK_USED' | cut -d '=' -f2)"
                
                echo "${_Cent}${_Sep}$(Data.Name.Linux $_Node ' ')${_Sep}$(Data.Line $pstd $_version)${_Sep}$(_wksMonitorParseDiskUsage $_DiskUsage $_DiskCapacity $_DiskTotal)${_Sep}$(Data.Line $pstd $_OSversion 12 )${_Sep}$(Data.Line $pstd $_ClangVersion)${_Sep}$(Data.Line " " " " 9)${_Sep}" | sed 's|%||g' | sed 's|+|%|g'
            else
                local _Data="$(_t4dSrcFileSystemSshT4dOutput $_Username@$_Ip '/Users/Shared/Tools4Dev' '_t4dSystemHealthInfo')"
                local _version="$(      echo $_Data | grep 'T4D_VERSION' | cut -d '=' -f2)"
                local _OSversion="$(    echo $_Data | grep 'SYSTEM_VERSION' | cut -d '=' -f2)"
                local _XcodeVersion="$( echo $_Data | grep 'XCODE_VERSION' | cut -d '=' -f2)"
                local _ClangVersion="$( echo $_Data | grep 'CLANG_VERSION' | cut -d '=' -f2)"
                local _DiskUsage="$(    echo $_Data | grep 'DISK_AVAILABLE_SPACE' | cut -d '=' -f2)"
                local _DiskCapacity="$( echo $_Data | grep 'DISK_PERCENTAGE' | cut -d '=' -f2)"
                local _DiskTotal="$(    echo $_Data | grep 'DISK_USED' | cut -d '=' -f2)"

                echo "${_Cent}${_Sep}$(Data.Name.OSX $_Node ' ')${_Sep}$(Data.Line $pstd $_version)${_Sep}$(_wksMonitorParseDiskUsage $_DiskUsage $_DiskCapacity $_DiskTotal)${_Sep}$(Data.Line $pstd $_OSversion 12 )${_Sep}$(Data.Line $pstd $_ClangVersion)${_Sep}$(Data.Line $pstd ${_XcodeVersion})${_Sep}" | sed 's|%||g' | sed 's|+|%|g'
            fi
        else
            echo "${_Cent}${_Sep}$(_t4dPromptVarCenterWithChar --color $pigrey 20 $_Node ' ')${_Sep}$(Data.Line " " " " 9)${_Sep}$(Data.Line " " " " 22)${_Sep}$(Data.Line " " " " 11)${_Sep}$(Data.Line " " " " 9)${_Sep}$(Data.Line " " " " 9)${_Sep}" | sed 's|%||g'
        fi
    done
    echo "${_Cent}$(_t4dPromptVarCenterWithChar --color "$_COLOR" 92 '' '+')" | sed 's|%||g'
#    _t4dDebugLog $pinfo "_wksMonitor not defined yet"
###############################
}

_wksGenerateLib(){
# Generated From $Tools4Dev_PATH/Engine/G4d/templates.env
# v1.7.0
###### _wksGenerateLib
#   - Name:
#       _wksGenerateLib
###
#   - Synopsis:
#       Oneline Description - Will be visible from wks help
###
#   - Note:
#       <Required>
#       [Optionnal]
#       {XXXXXXX}       = Value To Be Changed, if {URL} then replace {URL} with a valid URL
###
###### DOCUMENTATION BLOC #####
########### CODE BLOC #########
    local _t4dErrorCode=1
    local CHPWD=1
    local _DefaultServers="$(ls $WS_ROOT/srv)"
    local _Servers="${1:-$_DefaultServers}"
    local _Version="$(_wksGetVersion)"
    for _server in $(echo $_Servers); do
        if [[ -e "$WS_ROOT/srv/$_server/configuration.groovy" ]] && [[ -e "$WS_ROOT/generated-lib/$_server" ]]; then
            _t4dDebugLog $plog "$_server"
            cd "$WS_ROOT/generated-lib/$_server"
            
            rm -rf "${WS_ROOT}/generated-lib/$_server/src"
            cat "$WS_ROOT/_t4d_/readme.in" | sed "s|<NAME>|$_server|g" > "${WS_ROOT}/generated-lib/$_server/README.md"
            cp -r "${WS_ROOT}/src" "${WS_ROOT}/generated-lib/$_server/"
            if [[ -e "$WS_ROOT/srv/$_server/project" ]]; then
                cp -r "$WS_ROOT/srv/$_server/project" "${WS_ROOT}/generated-lib/$_server/src/"
            fi
            if [[ -e "$WS_ROOT/srv/$_server/slaves" ]]; then
                cp -rf "$WS_ROOT/srv/$_server/slaves" "${WS_ROOT}/generated-lib/$_server/src/"
            fi
            cp -rf "$WS_ROOT/srv/$_server/configuration.groovy" "${WS_ROOT}/generated-lib/$_server/src/system/jenkins/"
        else
            _t4dDebugLog $pskip "$_server"
        fi
    done


###############################
}

_wksGenerateIndex(){
# Generated From $Tools4Dev_PATH/Engine/G4d/templates.env
# v1.8.0
###### _wksGenerateIndex
#   - Name:
#       _wksGenerateIndex
###
#   - Synopsis:
#       Oneline Description - Will be visible from wks help
###
#   - Note:
#       <Required>
#       [Optionnal]
#       {XXXXXXX}       = Value To Be Changed, if {URL} then replace {URL} with a valid URL
###
###### DOCUMENTATION BLOC #####
########### CODE BLOC #########
    local _t4dErrorCode=1
    local CHPWD=1
    local _DefaultServers="$(ls $WS_ROOT/srv)"
    local _Version="$(_wksGetVersion)"
    local _InstallPrefix="${1:-"$WS_ROOT/generated-lib/$WS_CI_SERVER_NAME"}"
    if [[ -e "$WS_ROOT/srv/$WS_CI_SERVER_NAME/ci-config.xml" ]] && [[ -e "$WS_ROOT/generated-lib/$WS_CI_SERVER_NAME" ]]; then
        local _IndexRoot="${_InstallPrefix}/index"
        rm -rf "${_IndexRoot}"
        mkdir -p "${_IndexRoot}"
        _t4dDebugLog $plog "$WS_CI_SERVER_NAME"
        echo "date=$(date '+%y-%m-%d')" > $_IndexRoot/source.properties
        
        local _XmlFile="$WS_CI_CONFIG_FILE"
        local _Root="$(_t4dFindDataInXmlV2 folder name Home root $_XmlFile)"

        #Folder
        _t4dPromptSquare "Folders" $pblue
        local _Folders="$(_t4dFindMarkerInXML folder uuid $_XmlFile)"
        for _folder in $(echo $_Folders); do
            local _FolderName="$(_t4dFindDataInXmlV2 folder uuid "$_folder" name "$_XmlFile")"
            local _FolderBase="$(_t4dFindDataInXmlV2 folder uuid "$_folder" folderBase "$_XmlFile")"
            
            if [[ "$_FolderBase" != "" ]]; then
                local _RootPath="$(_wksJenkinsGetRootPath "$_FolderName" "${_FolderBase}" "$_XmlFile")"
                local _AbsolutePath="$(echo $_RootPath| sed "s|$_Root/||g" | sed 's|/jobs/|/|g' | tr '[:upper:]' '[:lower:]')"
                local _PropertiesFile="$_IndexRoot/$_AbsolutePath/_folder_.properties"
                if [[ "$_RootPath" != "/Home" ]]; then
                    _t4dDebugLog $plog "$_folder - $_AbsolutePath"
                    mkdir -p "$_IndexRoot/$_AbsolutePath"
                    echo "folder.name=$_folder" > $_PropertiesFile
                    echo "folder.path=$_RootPath" >> $_PropertiesFile
                    echo "folder.type=default" >> $_PropertiesFile
                else
                    _t4dDebugLog $pinfo "Home"
                fi
            fi
        done 

        #Pipeline
        _t4dPromptSquare "Pipeline" $pblue
        local _PipeLines="$(_t4dFindMarkerInXML pipeline uuid $_XmlFile)"
        for _Pipe in $(echo $_PipeLines); do
            local _PipeName="$(_t4dFindDataInXmlV2 pipeline uuid $_Pipe name $_XmlFile)"
            local _PipeFolderBase="$(_t4dFindDataInXmlV2 pipeline uuid $_Pipe folderBase $_XmlFile)"
            local _PipeFilterBranch="$(_t4dFindDataInXmlV2 pipeline uuid $_Pipe branchFilter $_XmlFile)"
            local _PipeJenkinsFile="$(_t4dFindDataInXmlV2 pipeline uuid $_Pipe jenkinsfile $_XmlFile)"
            local _RepoGit="$(_t4dFindDataInXmlV2 pipeline uuid $_Pipe repoGit $_XmlFile)"
            local _PipePath="$(_wksJenkinsGetRootPath $_PipeName $_PipeFolderBase $_XmlFile)"
            local _GitSource="$(_wksGitSourceUrl $_RepoGit $_XmlFile)"

            local _AbsolutePath="$(echo $_PipePath| sed "s|$_Root/||g" | sed 's|/jobs/|/|g' | tr '[:upper:]' '[:lower:]')"
            local _PropertiesFile="$_IndexRoot/${_AbsolutePath}.properties"
            _t4dDebugLog $plog "$_Pipe - $_AbsolutePath.properties"
            if [[ -e "$(dirname $_PropertiesFile)/_folder_.properties" ]]; then
                echo "pipeline.name=$_PipeName" > $_PropertiesFile
                echo "pipeline.filterBranch=$_PipeFilterBranch" >> $_PropertiesFile
                echo "pipeline.jenkinsFile=$_PipeJenkinsFile" >> $_PropertiesFile
                echo "pipeline.repoGit=$_GitSource" >> $_PropertiesFile
                echo "pipeline.path=$_PipePath" >> $_PropertiesFile
            else
                _t4dDebugLog $perror "cannot find folder base $(dirname $_PropertiesFile)"
                return $_t4dErrorCode
            fi
            
        done
    fi
###############################
}

_wksGenerate(){
# Generated From $Tools4Dev_PATH/Engine/G4d/templates.env
# v1.8.0
###### _wksGenerate
#   - Name:
#       _wksGenerate
###
#   - Synopsis:
#       Oneline Description - Will be visible from wks help
###
#   - Note:
#       <Required>
#       [Optionnal]
#       {XXXXXXX}       = Value To Be Changed, if {URL} then replace {URL} with a valid URL
###
###### DOCUMENTATION BLOC #####
########### CODE BLOC #########
    local _t4dErrorCode=1
    _wksGenerateLib $WS_CI_SERVER_NAME
    _wksGenerateIndex
###############################
}
